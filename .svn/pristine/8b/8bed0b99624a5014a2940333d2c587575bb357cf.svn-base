import { searchHouse, searchOffice } from '../../network/search.js';
Page({

  /**
   * 页面的初始数据
   */
  data: {
    hot_search:[],//热门搜索
    type:1,//2写字楼，1楼盘
    show:false,//搜索联动显示
    serchList:[],//搜索联动列表
    history:[],
    value:''
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.getLocalData(options);
  },
  getLocalData(options){
    if (options.type == 2){
      this.setData({
        hot_search: wx.getStorageSync('shangban_config') ? wx.getStorageSync('shangban_config').hot_search_office : [],
        type: options.type,
        history: wx.getStorageSync('office_house_search_history') ? wx.getStorageSync('office_house_search_history'):[]
      }); 
    } else {
      this.setData({
        history: wx.getStorageSync('office_project_search_history') ? wx.getStorageSync('office_project_search_history') : []
      });
    }
  },
  input(e){
    let txt = e.detail;
    this.setData({
      value:txt
    });
    if (this.data.type==2){
      this.searchHouse(txt);
    } else {
      this.searchOffice(txt);
    }
  },
  searchOffice(txt){//搜索楼盘房源
    searchOffice({
      blockname: txt
    }).then((res)=>{
      this.setData({
        serchList: res.data.data,
        show: res.data.data.length>0?true:false
      });
    });
  },
  searchHouse(txt){//搜索写字楼房源
    searchHouse({
      blockname: txt
    }).then((res) => {
      this.setData({
        serchList: res.data.data,
        show: true
      });
    }).catch(()=>{
      this.setData({
        serchList: [],
        show: false
      });
    });
  },
  searchList(e){//搜索完毕点击进入列表
    let id = e.currentTarget.dataset.id;
    let pro = e.currentTarget.dataset.pro;
    let item = e.currentTarget.dataset.item;
    let pages = getCurrentPages();
    if ((pro == 'blockid' || pro == 'office_id') && item) {//记录搜索历史
      this.recordHistory(item);
    }
    wx.redirectTo({
      url: '/shangban/pages/house-list/house-list?listType=' + this.data.type + '&' + pro + '=' + id +'&value=' + (item.name||item.blockname),
    })
  },
  recordHistory(obj) {//记录搜索历史
    let arr = this.data.history;
    arr.push(obj)
    if (this.data.type == 2){
      arr = this._filterArr(arr,'id');
      wx.setStorageSync('office_house_search_history', arr);
    } else {
      arr = this._filterArr(arr, 'office_id');
      wx.setStorageSync('office_project_search_history', arr)
    }
  },
  _filterArr(arr,pro){//过滤重复项
    let o = {};
    arr = arr.filter((item,index)=>{
      console.log(item[pro])
      if (!o[item[pro]]){
        o[item[pro]] = 1;
        return item;
      } 
    });
    return arr;
  },
  deleteHistory(){//删除搜索历史
    let _self = this;
    wx.showModal({
      title: '提示',
      content: '是否要清空搜索历史？',
      success(res) {
        if (res.confirm) {
          if (_self.data.type == 2) {
            wx.removeStorageSync('office_house_search_history');
          } else {
            wx.removeStorageSync('office_project_search_history');
          }
          _self.setData({
            history: []
          });
        } 
      }
    })
  },
  searcHot(e){
    let item = e.currentTarget.dataset.item;
    let url;
    if (item.keyword){
      url = '/shangban/pages/house-list/house-list?listType=' + this.data.type + '&keywork=' + item.keyword;
    }
    if (item.district_id){
      url = '/shangban/pages/house-list/house-list?listType=' + this.data.type + '&district=' + item.district_id + '&streetid=' + item.street_id;
    }
    url += '&value=' + (item.title);
    wx.redirectTo({
      url: url
    })
  },
  confirm(){
    wx.redirectTo({
      url:'/shangban/pages/house-list/house-list?listType=' + this.data.type + '&value=' + this.data.value
    })
  }
})